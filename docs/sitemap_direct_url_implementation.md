# Реализация прямых Sitemap URL для системы мониторинга ВГТРК

## Обзор решения

Мы успешно реализовали поддержку прямых sitemap URL в системе мониторинга ВГТРК. Это решение позволяет:

1. **Избежать проблем с sitemap_index.xml** - система теперь может работать напрямую с конкретными sitemap файлами
2. **Ускорить поиск** - нет необходимости загружать и парсить индексный файл
3. **Повысить точность** - можно указать точный sitemap для каждого филиала (например, sitemap2025.xml для текущего года)
4. **Упростить настройку** - администраторы могут вручную указать правильный sitemap для каждого филиала

## Изменения в системе

### 1. База данных

Добавлено новое поле `sitemap_url` в таблицу `filials`:

```sql
ALTER TABLE filials 
ADD COLUMN sitemap_url TEXT;
```

### 2. Модификация парсера (scrapy_parser.py)

#### Обновлен метод `find_sitemap`:
- Добавлен параметр `sitemap_url` для прямого указания URL
- Если передан прямой URL, он используется в первую очередь

#### Обновлен метод `parse_sitemap_urls`:
- Добавлена поддержка namespace с https (новый формат ГТРК Саха)
- Улучшена обработка sitemap_index с фильтрацией по годам

#### Обновлен метод `search_with_sitemap`:
- Добавлен параметр `sitemap_url` для передачи прямого URL

### 3. Пример использования

```python
from modules.scrapy_parser import ScrapyParser
from modules.advanced_logger import AdvancedLogger, LogLevel

# Инициализация
logger = AdvancedLogger(LogLevel.INFO)
parser = ScrapyParser(logger)

# Поиск с прямым sitemap URL
results = parser.search_with_sitemap(
    site_url="https://gtrksakha.ru",
    keywords=["Якутия", "Саха", "Айсен Николаев"],
    days=7,
    max_articles=50,
    sitemap_url="https://gtrksakha.ru/sitemap2025.xml"  # Прямой URL
)
```

## Результаты тестирования

### ГТРК Саха (Якутия)

- **Sitemap URL**: https://gtrksakha.ru/sitemap2025.xml
- **Размер файла**: 2.3 МБ
- **Количество URL**: 9260
- **Формат namespace**: https://www.sitemaps.org/schemas/sitemap/0.9

### Результаты поиска за 7 дней:
- Найдено URL: 254
- Релевантных статей: 31
- Ключевые слова: Якутия, Саха, Айсен Николаев, развитие, проект

## Рекомендации

### 1. Для администраторов

- Регулярно проверяйте актуальность sitemap URL для каждого филиала
- При смене года обновляйте URL (например, с sitemap2024.xml на sitemap2025.xml)
- Используйте robots.txt для поиска правильного sitemap URL

### 2. Для разработчиков

- При добавлении новых филиалов сначала проверяйте наличие sitemap через robots.txt
- Учитывайте возможные варианты namespace (http/https)
- Для больших sitemap файлов рассмотрите возможность кеширования

### 3. Оптимизация производительности

- Sitemap файлы могут быть большими (несколько МБ)
- Рекомендуется фильтровать по датам на уровне sitemap_index
- Используйте параметр `max_articles` для ограничения количества проверяемых статей

## Примеры sitemap URL для других филиалов

```python
# Примеры прямых sitemap URL
sitemap_urls = {
    "ГТРК Саха": "https://gtrksakha.ru/sitemap2025.xml",
    "ГТРК Вести": "https://vesti.ru/sitemap.xml",
    # Добавьте другие филиалы по мере необходимости
}
```

## Устранение неполадок

### Проблема: Sitemap не загружается
- Проверьте правильность URL
- Убедитесь, что сервер отвечает
- Проверьте robots.txt для поиска правильного sitemap

### Проблема: Не находятся статьи
- Проверьте формат дат в sitemap
- Убедитесь в правильности namespace (http vs https)
- Проверьте часовой пояс (некоторые sitemap используют локальное время)

## Заключение

Реализация прямых sitemap URL значительно улучшает производительность и надежность системы мониторинга. Теперь администраторы могут точно указывать, какой sitemap использовать для каждого филиала, что особенно важно для сайтов с большим объемом контента и сложной структурой sitemap файлов.