# Архитектура системы мониторинга ВГТРК

## Как работает система

### 1. Общий алгоритм работы:

```
[Список филиалов ВГТРК] 
         ↓
[1. ПАРСИНГ САЙТОВ]
   - BeautifulSoup извлекает контент с сайтов филиалов
   - Очистка HTML, извлечение текста
         ↓
[2. ПОИСК ПО ЗАПРОСАМ]
   - Проверка наличия ключевых слов в контенте
   - Фильтрация релевантного контента
         ↓
[3. АНАЛИЗ ЧЕРЕЗ GIGACHAT]
   - Отправка найденного контента в GigaChat API
   - Семантический анализ и оценка релевантности
   - Генерация выводов
         ↓
[4. СОХРАНЕНИЕ В БД]
   - SQLite база данных
   - Хранение результатов анализа
```

## Компоненты системы

### 1. **Парсер сайтов** (`modules/site_parser.py`)
- **Технология**: BeautifulSoup 4
- **Функция**: Извлечение текстового контента с веб-страниц
- **Процесс**:
  1. Загрузка HTML страницы
  2. Парсинг через BeautifulSoup
  3. Извлечение текста из тегов
  4. Очистка от скриптов и стилей
  5. Возврат чистого текста

### 2. **Клиент GigaChat** (`modules/gigachat_client.py`)
- **API**: GigaChat от Сбера
- **Функция**: Интеллектуальный анализ контента
- **Возможности**:
  - Семантический поиск упоминаний
  - Оценка тональности
  - Генерация кратких выводов
  - Классификация контента

### 3. **База данных** (`modules/database.py`)
- **Технология**: SQLite
- **Таблицы**:
  - `filials` - филиалы ВГТРК (95 записей)
  - `search_queries` - поисковые запросы
  - `monitoring_results` - результаты мониторинга
  - `logs` - логи системы

### 4. **Веб-интерфейс** (`app_sqlite.py`)
- **Технология**: Streamlit
- **Функции**:
  - Управление филиалами
  - Запуск мониторинга
  - Просмотр результатов
  - Статистика и отчеты

## Поток данных

### Шаг 1: Парсинг
```python
# Пример работы парсера
site_parser = SiteParser()
content = site_parser.parse_site("https://vesti42.ru")
# Возвращает: "Новости Кузбасса. Сегодня губернатор..."
```

### Шаг 2: Поиск
```python
# Проверка наличия ключевых слов
search_queries = ["губернатор", "ВГТРК", "местные новости"]
for query in search_queries:
    if query.lower() in content.lower():
        # Найдено совпадение - отправляем на анализ
```

### Шаг 3: Анализ GigaChat
```python
# Анализ через ИИ
gigachat = GigaChatClient(api_key, client_id)
analysis = gigachat.analyze_content(
    content="Губернатор Кузбасса провел встречу...",
    theme="деятельность губернатора"
)
# Возвращает: "В тексте найдено упоминание губернатора в контексте..."
```

### Шаг 4: Сохранение
```python
# Сохранение в БД
db.save_monitoring_result(
    filial_id=75,  # Кузбасс
    result={
        'url': 'vesti42.ru',
        'content': content,
        'analysis': analysis,
        'status': 'success'
    }
)
```

## Особенности реализации

### SSL и сертификаты
- GigaChat использует самоподписанный SSL-сертификат
- Требуется отключение проверки SSL (`verify=False`)
- Используется `urllib3.disable_warnings()` для подавления предупреждений

### Ограничения
- Максимум 8000 символов на запрос к GigaChat
- Токен GigaChat действует 30 минут
- Автообновление токена за 5 минут до истечения

### Коды регионов
- Кузбасс (Кемеровская область) - код 42
- Новосибирск - код 54
- Всего охвачено 9 федеральных округов

## Статистика системы

- **95** филиалов в базе данных
- **80** филиалов с активными сайтами (84%)
- **93** филиала с кодами регионов (97%)
- **73** сайта успешно обновлено
- **15** филиалов без сайтов (работают через соцсети или не имеют веб-присутствия)

## Запуск системы

```bash
# Установка зависимостей
pip install -r requirements.txt

# Инициализация БД
python init_database.py

# Обновление сайтов и кодов
python update_db_final.py

# Запуск веб-интерфейса
streamlit run app_sqlite.py
```

## Решение проблем

### Ошибка SSL сертификата GigaChat
**Проблема**: `[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed`

**Решение**: Добавлен параметр `verify=False` во все запросы к GigaChat API

### Филиалы без сайтов
Некоторые филиалы используют:
- Telegram каналы (ГТРК "Донецк")
- VKontakte страницы (ГТРК "Чукотка")
- Работают только в эфире без веб-присутствия

## Контакты и поддержка

Система разработана для мониторинга контента филиалов ВГТРК.
При возникновении вопросов обращайтесь к администратору системы.