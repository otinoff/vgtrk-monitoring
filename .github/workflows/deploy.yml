name: ğŸš€ Auto Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to ai-search.onff.ru
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸš€ Deploy to VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          echo "ğŸ”„ Starting deployment..."
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
          if [ ! -d "/var/www/vgtrk-monitoring" ]; then
            echo "ğŸ“ Creating project directory..."
            mkdir -p /var/www/vgtrk-monitoring
            cd /var/www/vgtrk-monitoring
            git clone https://github.com/otinoff/vgtrk-monitoring.git .
          else
            cd /var/www/vgtrk-monitoring
            echo "ğŸ“¥ Pulling latest changes..."
            git stash
            git pull origin main
          fi
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
          if [ ! -d "venv" ]; then
            echo "ğŸ Creating virtual environment..."
            python3 -m venv venv
          fi
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
          echo "ğŸ“¦ Installing dependencies..."
          source venv/bin/activate
          pip install --upgrade pip
          pip install streamlit pandas requests beautifulsoup4 lxml aiohttp streamlit-aggrid
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞµÑĞ»Ğ¸ ĞµÑ‘ Ğ½ĞµÑ‚
          mkdir -p data
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
          echo "ğŸ”§ Checking and fixing database structure..."
          python3 check_and_fix_database.py
          
          # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ±Ğ°Ğ·Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ°Ñ
          echo "ğŸ“Š Initializing database with filials data..."
          python3 init_database.py || echo "Database already initialized or init script not found"
          
          # Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ Ğ±Ğ°Ğ·Ñ‹ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
          echo "ğŸ“¤ Exporting existing data..."
          if [ -f "data/vgtrk_monitoring.db" ]; then
            python3 export_import_data.py export data/vgtrk_monitoring.db data/vgtrk_monitoring_export.json || echo "Export failed, continuing..."
          fi
          
          # Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ (Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
          echo "ğŸ“¥ Importing data..."
          if [ -f "data/vgtrk_monitoring_export.json" ]; then
            python3 export_import_data.py import data/vgtrk_monitoring.db data/vgtrk_monitoring_export.json || echo "Import failed, continuing..."
          fi
          
          # Ğ£Ğ±Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ streamlit
          echo "ğŸ”„ Restarting application..."
          pkill -f "streamlit run" || true
          
          # ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ¿Ğ°ÑƒĞ·Ğ°
          sleep 2
          
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ² Ñ„Ğ¾Ğ½Ğµ
          nohup streamlit run app_sqlite.py \
            --server.port 8501 \
            --server.address 0.0.0.0 \
            --server.headless true \
            > /var/www/vgtrk-monitoring/app.log 2>&1 &
          
          # Ğ–Ğ´Ñ‘Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
          echo "â³ Waiting for app to start..."
          sleep 5
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ»ÑÑ
          if pgrep -f "streamlit run" > /dev/null; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ Application available at: http://ai-search.onff.ru"
            echo "ğŸ“Š Direct access: http://5.35.88.251:8501"
            echo "ğŸ“ Check logs at: /var/www/vgtrk-monitoring/app.log"
          else
            echo "âŒ Failed to start application"
            echo "ğŸ“‹ Last 20 lines of log:"
            tail -20 /var/www/vgtrk-monitoring/app.log
            exit 1
          fi